<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
  <title>ÙØ§ØªÙˆØ±Ø© Ø§Ù„ Ø§ÙŠ Ø§Ø± Â· PDF Ø«Ø§Ø¨Øª</title>
  <!-- html2pdf Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù‘Ù†Ø© -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
    }

    body {
      background: #eef2f6;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 1.2rem;
    }

    .app-card {
      max-width: 820px;
      width: 100%;
      background: white;
      border-radius: 36px;
      box-shadow: 0 20px 40px -12px #1f4e3d4d;
      padding: 2rem 2rem;
      border: 1px solid #e0eae5;
    }

    h1, h2, h3, p, label, input, button {
      direction: rtl;
      text-align: right;
    }

    input[type="number"], input[readonly], input[type="tel"] {
      text-align: left;
      direction: ltr;
    }

    .input-group {
      margin-bottom: 1.2rem;
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #0b4e4b;
      margin-bottom: 0.25rem;
    }

    input {
      background: #f9fbfd;
      border: 1.5px solid #cde3de;
      border-radius: 30px;
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      outline: none;
      color: #174339;
    }

    input:focus {
      border-color: #008069;
      box-shadow: 0 0 0 3px #b0e5da;
    }

    input[readonly] {
      background: #e5f2ef;
      color: #024d40;
    }

    .row-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© - ØªØµÙ…ÙŠÙ… Ø®Ø§Ù„Ù Ù…Ù† Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø© */
    .invoice-preview {
      background: white;
      border-radius: 28px;
      padding: 2rem;
      margin: 2rem 0;
      border: 1px solid #d0e3dc;
      box-shadow: 0 6px 14px rgba(0,60,40,0.05);
      /* ØªØ¬Ù†Ø¨ Ø£ÙŠ ØªØ£Ø«ÙŠØ±Ø§Øª Ù‚Ø¯ ØªØ±Ø¨Ùƒ html2canvas */
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    .invoice-header {
      border-bottom: 2px solid #d0f0e4;
      padding-bottom: 1.2rem;
      margin-bottom: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .business-name {
      font-size: 2.2rem;
      font-weight: 800;
      color: #006653;
      line-height: 1;
    }

    .badge {
      background: #ecfdf6;
      padding: 0.3rem 1.2rem;
      border-radius: 40px;
      font-size: 0.8rem;
      font-weight: 600;
      color: #015d4e;
      border: 1px solid #b2e4d4;
      white-space: nowrap;
    }

    .invoice-line {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 0.6rem 0.2rem;
      border-bottom: 1px dashed #d2eae1;
      font-size: 1rem;
    }

    .invoice-line strong {
      color: #105e4f;
    }

    .invoice-line span {
      background: #f1faf7;
      padding: 0.2rem 1.2rem;
      border-radius: 40px;
      color: #014d3e;
    }

    .total-highlight {
      margin-top: 1.5rem;
      background: #e1f7f0;
      padding: 1rem 2rem;
      border-radius: 60px;
      font-size: 1.3rem;
      font-weight: 700;
      color: #00634d;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #9ed9c8;
    }

    .total-highlight small {
      font-size: 0.8rem;
      background: #b6ebdb;
      padding: 0.2rem 1rem;
      border-radius: 30px;
    }

    .action-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 2rem;
      justify-content: center;
    }

    .btn {
      border: none;
      background: white;
      padding: 0.9rem 1.8rem;
      border-radius: 60px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1 0 auto;
      min-width: 160px;
      box-shadow: 0 6px 14px rgba(0, 60, 40, 0.1);
      border: 1px solid #c0dad2;
      color: #025544;
      justify-content: center;
    }

    .btn-primary {
      background: #006653;
      color: white;
      border: none;
    }

    .btn-whatsapp {
      background: #25D366;
      color: white;
      border: none;
    }

    .btn-client {
      background: #f3fdfa;
      border: 2px solid #008069;
      color: #006653;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 20px -10px #006653b3;
    }

    .phone-hint {
      font-size: 0.7rem;
      color: #45786b;
      margin-right: 1.2rem;
    }

    .serial-note {
      font-size: 0.7rem;
      color: #4d7b6f;
      margin-right: 1.2rem;
    }

    @media (max-width: 600px) {
      .app-card { padding: 1.2rem; }
      .row-2col { grid-template-columns: 1fr; }
      .action-grid { flex-direction: column; }
    }
  </style>
</head>
<body>
<div class="app-card">
  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem;">
    <span style="font-size: 2rem;">ğŸ§¾</span>
    <h2 style="font-weight: 700; color: #005f4b;">Ù…Ù†Ø´Ø¦ ÙÙˆØ§ØªÙŠØ± Ø§Ù„ Ø§ÙŠ Ø§Ø± Â· PDF Ù…Ø¶Ù…ÙˆÙ†</h2>
  </div>

  <div class="input-group">
    <label>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
    <input type="text" id="clientName" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø´Ø±Ù‚" value="Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù…Ø§Ø³Ø©">
  </div>

  <div class="input-group">
    <label>ğŸ“± Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <input type="tel" id="clientPhone" placeholder="05xxxxxxxx" value="0501234567" dir="ltr">
  </div>

  <div class="input-group">
    <label>ğŸ“‹ ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø© / Ø§Ù„Ù…Ù†ØªØ¬</label>
    <input type="text" id="desc" placeholder="ØªØ·ÙˆÙŠØ± Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" value="ØªØ·ÙˆÙŠØ± Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  </div>

  <div class="input-group">
    <label>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ)</label>
    <input type="number" id="amount" step="0.01" min="0" value="2150.00">
  </div>

  <div class="row-2col">
    <div class="input-group">
      <label>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ® (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
      <input type="text" id="dateField" readonly>
    </div>
    <div class="input-group">
      <label>ğŸ”¢ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</label>
      <input type="text" id="serialField" readonly>
      <div class="serial-note">â±ï¸ ÙØ±ÙŠØ¯ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª</div>
    </div>
  </div>

  <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© - Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø·Ø¹Ø© Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ PDF -->
  <div id="invoicePreview" class="invoice-preview">
    <div class="invoice-header">
      <div class="business-name">Ø§Ù„ Ø§ÙŠ Ø§Ø±</div>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <span class="badge">Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ 2511017050</span>
        <span class="badge">ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</span>
      </div>
    </div>
    <div class="invoice-line"><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„</strong> <span id="previewClient">Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù…Ø§Ø³Ø©</span></div>
    <div class="invoice-line"><strong>Ø§Ù„Ø¬ÙˆØ§Ù„</strong> <span id="previewPhone">Ù Ù¥Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§</span></div>
    <div class="invoice-line"><strong>Ø§Ù„ÙˆØµÙ</strong> <span id="previewDesc">ØªØ·ÙˆÙŠØ± Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span></div>
    <div class="invoice-line"><strong>Ø§Ù„Ù…Ø¨Ù„Øº (SAR)</strong> <span id="previewAmount">Ù¢Ù¬Ù¡Ù¥Ù Ù«Ù Ù </span></div>
    <div class="invoice-line"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®</strong> <span id="previewDate">Ù¢Ù Ù¢Ù¥-Ù Ù£-Ù Ù¡</span></div>
    <div class="invoice-line"><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</strong> <span id="previewSerial">INV-1234</span></div>
    <div class="total-highlight">
      <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ (0% Ø¶Ø±ÙŠØ¨Ø©)</span>
      <span><span id="previewTotal">Ù¢Ù¬Ù¡Ù¥Ù Ù«Ù Ù </span> SAR <small>ØµÙØ± Ø¨Ø§Ù„Ù…Ø¦Ø©</small></span>
    </div>
  </div>

  <div class="action-grid">
    <button class="btn btn-primary" id="generatePDFBtn"><span>â¬‡ï¸</span> ØªØ­Ù…ÙŠÙ„ PDF</button>
    <button class="btn btn-whatsapp" id="whatsappShareBtn"><span>ğŸŒ</span> Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø·</button>
    <button class="btn btn-client" id="whatsappClientBtn"><span>ğŸ“</span> Ø£Ø±Ø³Ù„ PDF Ù„Ù„Ø¹Ù…ÙŠÙ„</button>
    <button class="btn" id="newInvoiceBtn"><span>â•</span> ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
  </div>
  <p style="text-align: center; font-size: 0.75rem; color: #577e72; margin-top: 1.5rem;">PDF ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ«ÙˆÙ‚ Â· Ø¥Ø±Ø³Ø§Ù„ PDF Ø¹Ø¨Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</p>
</div>

<script>
  (function() {
    // Ø¯ÙˆØ§Ù„ Ø£Ø³Ø§Ø³ÙŠØ©
    function getTodayString() {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    function generateSerial() {
      return 'INV-' + Date.now();
    }
    function formatCurrency(amount) {
      let num = parseFloat(amount);
      if (isNaN(num) || num < 0) num = 0;
      return num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    // Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const clientInput = document.getElementById('clientName');
    const phoneInput = document.getElementById('clientPhone');
    const descInput = document.getElementById('desc');
    const amountInput = document.getElementById('amount');
    const dateField = document.getElementById('dateField');
    const serialField = document.getElementById('serialField');

    const previewClient = document.getElementById('previewClient');
    const previewPhone = document.getElementById('previewPhone');
    const previewDesc = document.getElementById('previewDesc');
    const previewAmount = document.getElementById('previewAmount');
    const previewDate = document.getElementById('previewDate');
    const previewSerial = document.getElementById('previewSerial');
    const previewTotal = document.getElementById('previewTotal');
    const invoicePreviewDiv = document.getElementById('invoicePreview');

    function updatePreview() {
      previewClient.textContent = clientInput.value.trim() || 'â€”';
      previewPhone.textContent = phoneInput.value.trim() || 'â€”';
      previewDesc.textContent = descInput.value.trim() || 'â€”';
      let amountNum = parseFloat(amountInput.value) || 0;
      previewAmount.textContent = formatCurrency(amountNum);
      previewDate.textContent = dateField.value;
      previewSerial.textContent = serialField.value;
      previewTotal.textContent = formatCurrency(amountNum);
    }

    function setAutomaticFields() {
      dateField.value = getTodayString();
      serialField.value = generateSerial();
    }

    // ØªÙ‡ÙŠØ¦Ø© Ù…Ù† Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ØªØ±Ø§Øª (Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©)
    function initializeFromParams() {
      const urlParams = new URLSearchParams(window.location.search);
      dateField.value = (urlParams.get('date') && /^\d{4}-\d{2}-\d{2}$/.test(urlParams.get('date'))) ? urlParams.get('date') : getTodayString();
      serialField.value = urlParams.get('serial') || generateSerial();
      clientInput.value = urlParams.get('client') ? decodeURIComponent(urlParams.get('client')) : 'Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù…Ø§Ø³Ø©';
      phoneInput.value = urlParams.get('phone') ? decodeURIComponent(urlParams.get('phone')) : '0501234567';
      descInput.value = urlParams.get('desc') ? decodeURIComponent(urlParams.get('desc')) : 'ØªØ·ÙˆÙŠØ± Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';
      let amount = parseFloat(urlParams.get('amount'));
      amountInput.value = !isNaN(amount) ? amount.toFixed(2) : '2150.00';
      updatePreview();
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª html2pdf Ù…Ø­Ø³Ù‘Ù†Ø© ÙˆÙ…ÙˆØ«ÙˆÙ‚Ø©
    function generatePDFWithCallback(callback) {
      // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙƒØ«Ø± Ø§Ø³ØªÙ‚Ø±Ø§Ø±Ø§Ù‹
      const opt = {
        margin:        [0.5, 0.5, 0.5, 0.5],
        filename:     `ÙØ§ØªÙˆØ±Ø©_${serialField.value}.pdf`,
        image:        { type: 'jpeg', quality: 0.95 },
        html2canvas:  { 
          scale: 1.5,            // Ø®ÙØ¶Ù†Ø§ scale Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
          useCORS: true,
          logging: false,
          letterRendering: true,
          allowTaint: false,
          backgroundColor: '#FFFFFF' // Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ Ù‚Ø³Ø±ÙŠØ©
        },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      return html2pdf().set(opt).from(invoicePreviewDiv).output('blob');
    }

    // ØªØ­Ù…ÙŠÙ„ PDF Ù…Ø¨Ø§Ø´Ø±
    document.getElementById('generatePDFBtn').addEventListener('click', function() {
      generatePDFWithCallback().then(function(blob) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `ÙØ§ØªÙˆØ±Ø©_${serialField.value}.pdf`;
        link.click();
        URL.revokeObjectURL(link.href);
      }).catch(err => {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDFØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        console.error(err);
      });
    });

    // Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ (Ù†Øµ ÙÙ‚Ø·)
    document.getElementById('whatsappShareBtn').addEventListener('click', function() {
      const params = new URLSearchParams({
        client: clientInput.value,
        phone: phoneInput.value,
        desc: descInput.value,
        amount: parseFloat(amountInput.value).toFixed(2),
        serial: serialField.value,
        date: dateField.value
      });
      const link = window.location.origin + window.location.pathname + '?' + params.toString();
      const text = `ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„ Ø§ÙŠ Ø§Ø±\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${clientInput.value}\nØ§Ù„Ù…Ø¨Ù„Øº: ${amountInput.value} SAR\nØ±Ø§Ø¨Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${link}`;
      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
    });

    // Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ PDF Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù Ø¹Ø¨Ø± Web Share)
    document.getElementById('whatsappClientBtn').addEventListener('click', async function() {
      try {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF
        const blob = await generatePDFWithCallback();
        const file = new File([blob], `ÙØ§ØªÙˆØ±Ø©_${serialField.value}.pdf`, { type: 'application/pdf' });

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© (ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø£ØºÙ„Ø¨ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¬ÙˆØ§Ù„)
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            files: [file],
            title: 'ÙØ§ØªÙˆØ±Ø©',
            text: 'ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„ Ø§ÙŠ Ø§Ø±'
          });
        } else {
          // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©ØŒ Ù†Ù†Ø²Ù„ Ø§Ù„Ù…Ù„Ù
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `ÙØ§ØªÙˆØ±Ø©_${serialField.value}.pdf`;
          link.click();
          URL.revokeObjectURL(link.href);
          alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù PDFØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.');
        }
      } catch (error) {
        console.error('Share error:', error);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø£Ùˆ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ØŒ Ù†Ù†Ø²Ù„ Ø§Ù„Ù…Ù„Ù ÙƒØ§Ø­ØªÙŠØ§Ø·ÙŠ
        const blob = await generatePDFWithCallback();
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `ÙØ§ØªÙˆØ±Ø©_${serialField.value}.pdf`;
        link.click();
        URL.revokeObjectURL(link.href);
      }
    });

    // ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
    document.getElementById('newInvoiceBtn').addEventListener('click', function() {
      clientInput.value = '';
      phoneInput.value = '';
      descInput.value = '';
      amountInput.value = '';
      dateField.value = getTodayString();
      serialField.value = generateSerial();
      updatePreview();
    });

    // Ø±Ø¨Ø· Ø§Ù„ØªØ­Ø¯ÙŠØ«
    clientInput.addEventListener('input', updatePreview);
    phoneInput.addEventListener('input', updatePreview);
    descInput.addEventListener('input', updatePreview);
    amountInput.addEventListener('input', updatePreview);

    // ØªØ´ØºÙŠÙ„
    setAutomaticFields();
    initializeFromParams();
  })();
</script>
</body>
</html>