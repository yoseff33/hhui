<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
  <title>ÙØ§ØªÙˆØ±Ø© Ø§Ù„ Ø§ÙŠ Ø§Ø± Â· Ø¥ØµØ¯Ø§Ø± Ù…Ù…ÙŠØ²</title>
  <!-- html2pdf (PDF Ù†Ø¸ÙŠÙ) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Tajawal', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
    }

    /* Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø®Ø· Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ø¹ØµØ±ÙŠ */
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');

    body {
      background: linear-gradient(145deg, #eef2f6 0%, #f9fcff 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 1.2rem;
    }

    .app-card {
      max-width: 820px;
      width: 100%;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 48px;
      box-shadow: 0 30px 60px -20px rgba(0, 70, 60, 0.4), 0 0 0 1px rgba(0, 128, 105, 0.15) inset;
      padding: 2.2rem 2rem;
      transition: all 0.25s;
      border: 1px solid rgba(255,255,255,0.5);
    }

    h1, h2, h3, p, label, input, button, .invoice-card {
      direction: rtl;
      text-align: right;
    }

    /* Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø±Ù‚Ù…ÙŠØ© ØªØ¨Ù‚Ù‰ Ù…Ù‚Ø±ÙˆØ¡Ø© */
    input[type="number"], input[readonly], input[type="tel"] {
      text-align: left;
      direction: ltr;
    }

    .input-group {
      margin-bottom: 1.3rem;
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #0b4e4b;
      margin-bottom: 0.25rem;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    label i {
      font-size: 1.2rem;
      filter: drop-shadow(0 2px 2px rgba(0,80,70,0.2));
    }

    input {
      background: #ffffffd9;
      border: 1.5px solid #cde3de;
      border-radius: 30px;
      padding: 0.9rem 1.5rem;
      font-size: 1rem;
      outline: none;
      transition: 0.2s;
      color: #174339;
      font-weight: 500;
      box-shadow: 0 4px 10px rgba(0, 50, 30, 0.02);
    }

    input:focus {
      border-color: #008069;
      background: white;
      box-shadow: 0 8px 18px -10px #00665380, 0 0 0 3px #b0e5da;
    }

    input[readonly] {
      background: #e5f2ef;
      color: #024d40;
      font-weight: 600;
      border-color: #b3d9cf;
    }

    .row-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¨Ø·Ø§Ù‚Ø© Ø£Ù†ÙŠÙ‚Ø©) */
    .invoice-preview {
      background: #ffffff;
      border-radius: 40px;
      padding: 2rem 2rem;
      margin: 2rem 0 2rem;
      box-shadow: 0 18px 35px -12px #1f4e3d4d, 0 0 0 1px #bfe3da inset;
      border: 1px solid #fff9;
    }

    .invoice-header {
      border-bottom: 3px solid #d0f0e4;
      padding-bottom: 1.2rem;
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .business-name {
      font-size: 2.4rem;
      font-weight: 800;
      background: linear-gradient(130deg, #006653, #00997a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
    }

    .cr-tax {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .badge {
      background: #ecfdf6;
      padding: 0.35rem 1.2rem;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
      color: #015d4e;
      border: 1px solid #b2e4d4;
      box-shadow: 0 2px 6px #c0efdd;
      white-space: nowrap;
    }

    .invoice-line {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 0.7rem 0.2rem;
      border-bottom: 1px dashed #d2eae1;
      font-size: 1.05rem;
    }

    .invoice-line strong {
      color: #105e4f;
      font-weight: 650;
    }

    .invoice-line span {
      background: #f1faf7;
      padding: 0.25rem 1.5rem;
      border-radius: 40px;
      color: #014d3e;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .total-highlight {
      margin-top: 1.8rem;
      background: #e1f7f0;
      padding: 1.2rem 2rem;
      border-radius: 60px;
      font-size: 1.5rem;
      font-weight: 750;
      color: #00634d;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #9ed9c8;
      box-shadow: 0 10px 20px -15px #00261e;
    }

    .total-highlight small {
      font-size: 0.9rem;
      font-weight: 450;
      background: #b6ebdb;
      padding: 0.2rem 1.2rem;
      border-radius: 30px;
      color: #00473b;
    }

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© */
    .action-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 2rem;
      justify-content: center;
    }

    .btn {
      border: none;
      background: white;
      padding: 0.9rem 1.8rem;
      border-radius: 70px;
      font-size: 1.05rem;
      font-weight: 650;
      cursor: pointer;
      transition: 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.7rem;
      flex: 1 0 auto;
      min-width: 170px;
      box-shadow: 0 6px 14px rgba(0, 60, 40, 0.12);
      border: 1px solid rgba(0,128,105,0.2);
      color: #025544;
    }

    .btn-primary {
      background: #006653;
      color: white;
      border: 1px solid #008f74;
      box-shadow: 0 12px 22px -12px #006653b3;
    }

    .btn-whatsapp {
      background: #25D366;
      color: white;
      border: 1px solid #20b859;
    }

    .btn-client {
      background: #f3fdfa;
      border: 2px solid #008069;
      color: #006653;
    }

    .btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 22px 28px -14px #006653cc;
    }

    .btn:active {
      transform: translateY(2px);
      box-shadow: 0 8px 12px -8px #1b5e4f;
    }

    /* ØªÙ„Ù…ÙŠØ­Ø§Øª ÙˆØ­Ù‚ÙˆÙ„ Ø§Ù„Ø¬ÙˆØ§Ù„ */
    .phone-hint {
      font-size: 0.7rem;
      color: #45786b;
      margin-right: 1.2rem;
      margin-top: 0.1rem;
    }

    .serial-note {
      font-size: 0.7rem;
      color: #4d7b6f;
      margin-right: 1.2rem;
    }

    /* Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    @media (max-width: 600px) {
      .app-card { padding: 1.5rem; border-radius: 36px; }
      .row-2col { grid-template-columns: 1fr; }
      .action-grid { flex-direction: column; }
      .btn { width: 100%; }
      .invoice-header { flex-direction: column; gap: 10px; }
      .business-name { font-size: 2rem; }
    }

    /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ØµØºÙŠØ±Ø© (Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙƒØ¨Ø¯Ø§Ø¦Ù„) */
    .icon { font-size: 1.2rem; }
  </style>
</head>
<body>
<div class="app-card">
  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 1.2rem;">
    <span style="font-size: 2rem;">ğŸ§¾</span>
    <h2 style="font-weight: 700; color: #005f4b; letter-spacing: -0.02em;">Ù…Ù†Ø´Ø¦ ÙÙˆØ§ØªÙŠØ± Ø§Ù„ Ø§ÙŠ Ø§Ø± Â· Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø©</h2>
  </div>

  <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© + Ø§Ù„Ø¬ÙˆØ§Ù„ -->
  <div class="input-group">
    <label><i>ğŸ‘¤</i> Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
    <input type="text" id="clientName" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø´Ø±Ù‚" value="Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù…Ø§Ø³Ø©">
  </div>

  <!-- Ø­Ù‚Ù„ Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø·Ù„ÙˆØ¨ Ù„Ø®Ø§ØµÙŠØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„) -->
  <div class="input-group">
    <label><i>ğŸ“±</i> Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø³Ø¹ÙˆØ¯ÙŠ)</label>
    <input type="tel" id="clientPhone" placeholder="Ù…Ø«Ø§Ù„: 05xxxxxxxx" value="0501234567" dir="ltr">
    <div class="phone-hint">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨ØµÙŠØºØ© Ø³Ø¹ÙˆØ¯ÙŠØ© (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05) Ù„ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</div>
  </div>

  <div class="input-group">
    <label><i>ğŸ“‹</i> ÙˆØµÙ Ø§Ù„Ø®Ø¯Ù…Ø© / Ø§Ù„Ù…Ù†ØªØ¬</label>
    <input type="text" id="desc" placeholder="Ù…Ø«Ø§Ù„: ØªØµÙ…ÙŠÙ… Ù‡ÙˆÙŠØ© ØªØ¬Ø§Ø±ÙŠØ©" value="ØªØ·ÙˆÙŠØ± Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
  </div>

  <div class="input-group">
    <label><i>ğŸ’°</i> Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ)</label>
    <input type="number" id="amount" step="0.01" min="0" value="2150.00">
  </div>

  <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© -->
  <div class="row-2col">
    <div class="input-group">
      <label><i>ğŸ“…</i> Ø§Ù„ØªØ§Ø±ÙŠØ® (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
      <input type="text" id="dateField" readonly>
    </div>
    <div class="input-group">
      <label><i>ğŸ”¢</i> Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</label>
      <input type="text" id="serialField" class="serial-field" readonly>
      <div class="serial-note">â±ï¸ ÙØ±ÙŠØ¯ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª</div>
    </div>
  </div>

  <!-- Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ù„Ù…Ø±Ø¦ÙŠØ© + PDF) -->
  <div id="invoicePreview" class="invoice-preview">
    <div class="invoice-header">
      <div class="business-name">Ø§Ù„ Ø§ÙŠ Ø§Ø±</div>
      <div class="cr-tax">
        <span class="badge">ğŸš€ Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ 2511017050</span>
        <span class="badge">âš–ï¸ ØºÙŠØ± Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©</span>
      </div>
    </div>

    <div class="invoice-line">
      <strong>Ø§Ù„Ø¹Ù…ÙŠÙ„</strong> <span id="previewClient">Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù…Ø§Ø³Ø©</span>
    </div>
    <div class="invoice-line">
      <strong>Ø§Ù„Ø¬ÙˆØ§Ù„</strong> <span id="previewPhone">Ù Ù¥Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§</span>
    </div>
    <div class="invoice-line">
      <strong>Ø§Ù„ÙˆØµÙ</strong> <span id="previewDesc">ØªØ·ÙˆÙŠØ± Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
    </div>
    <div class="invoice-line">
      <strong>Ø§Ù„Ù…Ø¨Ù„Øº (SAR)</strong> <span id="previewAmount">Ù¢Ù¬Ù¡Ù¥Ù Ù«Ù Ù </span>
    </div>
    <div class="invoice-line">
      <strong>Ø§Ù„ØªØ§Ø±ÙŠØ®</strong> <span id="previewDate">Ù¢Ù Ù¢Ù¥-Ù Ù£-Ù Ù¡</span>
    </div>
    <div class="invoice-line">
      <strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</strong> <span id="previewSerial" class="serial-field">INV-1712345678901</span>
    </div>

    <div class="total-highlight">
      <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ (0% Ø¶Ø±ÙŠØ¨Ø©)</span>
      <span><span id="previewTotal">Ù¢Ù¬Ù¡Ù¥Ù Ù«Ù Ù </span> SAR <small>ØµÙØ± Ø¨Ø§Ù„Ù…Ø¦Ø©</small></span>
    </div>
  </div>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…: PDF + Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø§Ù…Ø© + Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„ -->
  <div class="action-grid">
    <button class="btn btn-primary" id="generatePDFBtn"><span class="icon">â¬‡ï¸</span> ØªØ­Ù…ÙŠÙ„ PDF</button>
    <button class="btn btn-whatsapp" id="whatsappShareBtn"><span class="icon">ğŸŒ</span> Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
    <button class="btn btn-client" id="whatsappClientBtn"><span class="icon">ğŸ“²</span> Ø£Ø±Ø³Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„</button>
    <button class="btn" id="newInvoiceBtn"><span class="icon">â•</span> ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
  </div>

  <p style="text-align: center; font-size: 0.75rem; color: #577e72; margin-top: 1.5rem;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù†Ù‡Ø§Ø¦ÙŠØ© Â· Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¶Ø±ÙŠØ¨Ø© Ù…Ø¶Ø§ÙØ© Â· ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ</p>
</div>

<script>
  (function() {
    // -------------------- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© --------------------
    function getTodayString() {
      const d = new Date();
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function generateSerial() {
      return 'INV-' + Date.now(); // timestamp ÙØ±ÙŠØ¯
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø¨Ù„Øº (ÙØ§ØµÙ„Ø© ÙƒÙ„ Ø«Ù„Ø§Ø« Ø®Ø§Ù†Ø§Øª)
    function formatCurrency(amount) {
      let num = parseFloat(amount);
      if (isNaN(num) || num < 0) num = 0;
      return num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¥Ù„Ù‰ ØµÙŠØºØ© Ø¯ÙˆÙ„ÙŠØ© Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ø³Ø¹ÙˆØ¯ÙŠ)
    function formatPhoneForWhatsApp(phone) {
      // ÙŠÙ†Ø¸Ù Ø§Ù„Ø±Ù‚Ù… Ù…Ù† Ø£ÙŠ Ø­Ø±Ù ØºÙŠØ± Ø±Ù‚Ù…ÙŠ
      let digits = phone.replace(/\D/g, '');
      // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 Ø£Ùˆ 5 (Ø³Ø¹ÙˆØ¯ÙŠ) Ù†Ø­ÙˆÙ„Ù‡ Ø¥Ù„Ù‰ 9665...
      if (digits.startsWith('05') && digits.length === 10) {
        return '966' + digits.substring(1); // 05xxxxxxxx -> 9665xxxxxxxx
      } else if (digits.startsWith('5') && digits.length === 9) {
        return '966' + digits;
      } else if (digits.startsWith('966') && digits.length >= 11) {
        return digits; // Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø¨Ø§Ù„ÙØ¹Ù„ Ø¯ÙˆÙ„ÙŠ
      }
      // Ø¥Ø°Ø§ Ù…Ø§ Ø§Ù†Ø·Ø¨Ù‚ØŒ Ø£Ø±Ø¬Ø¹ Ø§Ù„Ø±Ù‚Ù… ÙƒÙ…Ø§ Ù‡Ùˆ Ù…Ø¹ Ù…Ø³Ø§ÙØ©? Ù„ÙƒÙ† Ù†Ø­Ø§ÙˆÙ„ Ù†Ø¬Ø¹Ù„Ù‡ ØµØ§Ù„Ø­Ø§Ù‹
      return digits; 
    }

    // -------------------- Ø¹Ù†Ø§ØµØ± DOM --------------------
    const clientInput = document.getElementById('clientName');
    const phoneInput = document.getElementById('clientPhone');
    const descInput = document.getElementById('desc');
    const amountInput = document.getElementById('amount');
    const dateField = document.getElementById('dateField');
    const serialField = document.getElementById('serialField');

    const previewClient = document.getElementById('previewClient');
    const previewPhone = document.getElementById('previewPhone');
    const previewDesc = document.getElementById('previewDesc');
    const previewAmount = document.getElementById('previewAmount');
    const previewDate = document.getElementById('previewDate');
    const previewSerial = document.getElementById('previewSerial');
    const previewTotal = document.getElementById('previewTotal');

    const invoicePreviewDiv = document.getElementById('invoicePreview');

    // -------------------- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© --------------------
    function updatePreview() {
      let client = clientInput.value.trim() || 'â€”';
      let phone = phoneInput.value.trim() || 'â€”';
      let desc = descInput.value.trim() || 'â€”';
      let amountNum = parseFloat(amountInput.value);
      if (isNaN(amountNum) || amountNum < 0) amountNum = 0;

      previewClient.textContent = client;
      // Ù†Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ù‚Ø±ÙˆØ¡ (Ù†ÙØ³ Ø§Ù„Ù…Ø¯Ø®Ù„)
      previewPhone.textContent = phone || 'â€”';
      previewDesc.textContent = desc;
      previewAmount.textContent = formatCurrency(amountNum);
      previewDate.textContent = dateField.value;
      previewSerial.textContent = serialField.value;
      previewTotal.textContent = formatCurrency(amountNum);
    }

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ
    function setAutomaticFields() {
      dateField.value = getTodayString();
      serialField.value = generateSerial();
    }

    // ØªÙ‡ÙŠØ¦Ø© Ù…Ù† Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ØªØ±Ø§Øª Ø¥Ù† ÙˆØ¬Ø¯Øª (Ù…Ø´Ø§Ø±ÙƒØ©)
    function initializeFromParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const clientParam = urlParams.get('client');
      const phoneParam = urlParams.get('phone');
      const descParam = urlParams.get('desc');
      const amountParam = urlParams.get('amount');
      const serialParam = urlParams.get('serial');
      const dateParam = urlParams.get('date');

      if (dateParam && /^\d{4}-\d{2}-\d{2}$/.test(dateParam)) {
        dateField.value = dateParam;
      } else {
        dateField.value = getTodayString();
      }

      if (serialParam) {
        serialField.value = serialParam;
      } else {
        serialField.value = generateSerial();
      }

      if (clientParam) clientInput.value = decodeURIComponent(clientParam);
      else clientInput.value = 'Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù…Ø§Ø³Ø©';

      if (phoneParam) phoneInput.value = decodeURIComponent(phoneParam);
      else phoneInput.value = '0501234567';

      if (descParam) descInput.value = decodeURIComponent(descParam);
      else descInput.value = 'ØªØ·ÙˆÙŠØ± Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ';

      if (amountParam && !isNaN(parseFloat(amountParam))) {
        amountInput.value = parseFloat(amountParam).toFixed(2);
      } else {
        amountInput.value = '2150.00';
      }

      updatePreview();
    }

    // Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© (ÙŠØ­Ù…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    function getShareableLink() {
      const baseUrl = window.location.origin + window.location.pathname;
      const params = new URLSearchParams();

      params.set('client', clientInput.value.trim() || '');
      params.set('phone', phoneInput.value.trim() || '');
      params.set('desc', descInput.value.trim() || '');
      let amountNum = parseFloat(amountInput.value);
      if (!isNaN(amountNum) && amountNum >= 0) {
        params.set('amount', amountNum.toFixed(2));
      }
      params.set('serial', serialField.value);
      params.set('date', dateField.value);

      return baseUrl + '?' + params.toString();
    }

    // -------------------- Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ (Ø¹Ø§Ù…) --------------------
    function shareWhatsAppGeneric() {
      const client = clientInput.value.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const phone = phoneInput.value.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const desc = descInput.value.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const amount = parseFloat(amountInput.value) || 0;
      const serial = serialField.value;
      const date = dateField.value;
      const link = getShareableLink();

      const messageLines = [
        'ğŸ§¾ *ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„ Ø§ÙŠ Ø§Ø±*',
        `ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${client}`,
        `ğŸ“± Ø¬ÙˆØ§Ù„: ${phone}`,
        `ğŸ“‹ Ø§Ù„ÙˆØµÙ: ${desc}`,
        `ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${amount.toFixed(2)} SAR`,
        `ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}`,
        `ğŸ”¢ Ø§Ù„Ø±Ù‚Ù…: ${serial}`,
        `ğŸ”„ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³ÙˆÙ… (0% Ø¶Ø±ÙŠØ¨Ø©)`,
        `ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${link}`
      ];

      const message = messageLines.join('\n');
      const encoded = encodeURIComponent(message);
      window.open(`https://wa.me/?text=${encoded}`, '_blank');
    }

    // -------------------- Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„) --------------------
    function sendToClientViaWhatsApp() {
      let rawPhone = phoneInput.value.trim();
      if (!rawPhone) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }

      const formattedPhone = formatPhoneForWhatsApp(rawPhone);
      if (!formattedPhone) {
        alert('Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø³Ø¹ÙˆØ¯ÙŠ ØµØ­ÙŠØ­ (Ù…Ø«Ù„ 05xxxxxxxx).');
        return;
      }

      const client = clientInput.value.trim() || 'Ø§Ù„Ø¹Ù…ÙŠÙ„';
      const desc = descInput.value.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const amount = parseFloat(amountInput.value) || 0;
      const serial = serialField.value;
      const date = dateField.value;
      const link = getShareableLink(); // Ø±Ø§Ø¨Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©

      const messageLines = [
        `ğŸ§¾ *ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„ Ø§ÙŠ Ø§Ø±*`,
        `ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${client}`,
        `ğŸ“‹ Ø§Ù„Ø®Ø¯Ù…Ø©: ${desc}`,
        `ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${amount.toFixed(2)} SAR`,
        `ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}`,
        `ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${serial}`,
        `ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${link}`,
        `âš¡ Ø´Ø§Ù…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³ÙˆÙ… (0% Ø¶Ø±ÙŠØ¨Ø©)`
      ];

      const message = messageLines.join('\n');
      const encoded = encodeURIComponent(message);
      // ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆÙ„ÙŠ
      window.open(`https://wa.me/${formattedPhone}?text=${encoded}`, '_blank');
    }

    // -------------------- PDF --------------------
    function generatePDF() {
      const opt = {
        margin:        [0.5, 0.5, 0.5, 0.5],
        filename:     `ÙØ§ØªÙˆØ±Ø©_${serialField.value}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true, letterRendering: true },
        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(invoicePreviewDiv).save();
    }

    // -------------------- ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© --------------------
    function resetToNewInvoice() {
      clientInput.value = '';
      phoneInput.value = '';
      descInput.value = '';
      amountInput.value = '';
      dateField.value = getTodayString();
      serialField.value = generateSerial();
      updatePreview();
    }

    // -------------------- Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« --------------------
    clientInput.addEventListener('input', updatePreview);
    phoneInput.addEventListener('input', updatePreview);
    descInput.addEventListener('input', updatePreview);
    amountInput.addEventListener('input', updatePreview);

    document.getElementById('generatePDFBtn').addEventListener('click', generatePDF);
    document.getElementById('whatsappShareBtn').addEventListener('click', shareWhatsAppGeneric);
    document.getElementById('whatsappClientBtn').addEventListener('click', sendToClientViaWhatsApp);
    document.getElementById('newInvoiceBtn').addEventListener('click', resetToNewInvoice);

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    initializeFromParams();
  })();
</script>
</body>
</html>