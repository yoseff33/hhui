<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¸Ø§Ù… ÙÙˆØ§ØªÙŠØ± Ù„ÙŠØ± Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª Â· Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: #eef2f6;
      font-family: 'Segoe UI', Tahoma, system-ui, sans-serif;
      padding: 20px;
    }
    .card {
      max-width: 1300px;
      margin: auto;
      background: white;
      padding: 25px;
      border-radius: 28px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.08);
    }
    h2 { margin: 0 0 20px; color: #0e2b3d; display: flex; gap: 10px; flex-wrap: wrap; }
    .row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
    .col { flex: 1 1 180px; }
    input, select, button, textarea {
      padding: 12px 16px;
      border-radius: 18px;
      border: 1px solid #cbd5e1;
      font-size: 15px;
      width: 100%;
      background: #fafdff;
    }
    input:focus { border-color: #006653; outline: none; background: white; }
    button {
      background: #006653;
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,102,83,0.25);
      transition: 0.2s;
    }
    button:hover { background: #004d3e; transform: translateY(-2px); }
    .btn-light {
      background: #f0f5fb;
      color: #153b4f;
      box-shadow: none;
    }
    .btn-light:hover { background: #e1eaf3; transform: none; }
    .invoice {
      margin-top: 35px;
      border: 1px solid #dde5ef;
      padding: 30px;
      border-radius: 40px;
      background: white;
      box-shadow: 0 10px 30px rgba(0,0,0,0.02);
    }
    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .shop-details h1 {
      font-size: 28px;
      margin: 0 0 5px;
      color: #001f1a;
      font-weight: 800;
    }
    .shop-details p { margin: 4px 0; color: #2f566b; }
    .tax-badge {
      background: #edf3f8;
      padding: 6px 18px;
      border-radius: 50px;
      font-size: 14px;
      display: inline-block;
    }
    .logo { max-height: 80px; max-width: 200px; object-fit: contain; }
    .invoice-meta {
      display: flex;
      justify-content: space-between;
      background: #f0f7fc;
      padding: 16px 22px;
      border-radius: 40px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .customer-info {
      background: #f9fcfd;
      padding: 20px;
      border-radius: 32px;
      border: 1px solid #e1ecf5;
      margin-bottom: 25px;
    }
    .payment-method {
      display: flex;
      align-items: center;
      gap: 15px;
      background: #eff7fa;
      padding: 10px 25px;
      border-radius: 60px;
      margin-bottom: 20px;
    }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th {
      background: #e2eef9;
      color: #13473b;
      padding: 14px 8px;
      border-radius: 24px 24px 0 0;
    }
    td { padding: 10px 8px; border-bottom: 1px solid #d2e0ed; }
    .item-row input { padding: 8px 12px; border-radius: 20px; }
    .totals {
      background: #f2f9ff;
      padding: 20px 25px;
      border-radius: 40px;
      margin-top: 20px;
    }
    .total-line { display: flex; justify-content: space-between; margin: 8px 0; }
    .grand-total {
      font-size: 24px;
      font-weight: 700;
      color: #004d40;
      border-top: 2px dashed #b2cde0;
      padding-top: 15px;
      margin-top: 12px;
    }
    .thanks-message {
      background: #dff0e9;
      color: #0b463a;
      padding: 18px 25px;
      border-radius: 60px;
      font-size: 18px;
      font-weight: 500;
      text-align: center;
      margin: 20px 0;
    }
    .qr-section { display: flex; justify-content: flex-end; }
    #qrcode { background: white; padding: 10px; border-radius: 24px; }
    .saved-list {
      margin-top: 30px;
      background: #f5faff;
      padding: 20px;
      border-radius: 40px;
    }
    .saved-item {
      padding: 14px 20px;
      background: white;
      border: 1px solid #c9ddef;
      border-radius: 30px;
      margin: 8px 0;
      cursor: pointer;
    }
    .saved-item:hover { border-color: #006653; background: #f0f9fc; }
    .whatsapp-btn { background: #25D366; color: white; }
    .whatsapp-btn:hover { background: #128C7E; }
  </style>
</head>
<body>
<div class="card">
  <h2>ğŸ“„ ÙØ§ØªÙˆØ±Ø© Ù„ÙŠØ± Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª <span style="font-size:14px; color:#4f6f8f;">(Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ Ù†ØµØŒ Ø¶Ø±ÙŠØ¨Ø© Ø§Ù„ØªØ§Ø¬Ø±ØŒ Ø´Ø¹Ø§Ø± Ø¨Ø±Ø§Ø¨Ø·ØŒ PDF Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨)</span></h2>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <div class="row">
    <div class="col"><input type="text" id="clientName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" value="Ù…Ø­Ù…Ø¯ Ø³Ù„ÙŠÙ…Ø§Ù†"></div>
    <div class="col"><input type="text" id="clientPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨)" value="01012390339"></div>
    <div class="col"><input type="text" id="clientTaxId" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„" value="123123123123"></div>
  </div>
  <div class="row">
    <div class="col"><input type="text" id="issuer" placeholder="Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ / Ù…ØµØ¯Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø©" value="(1) - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©"></div>
    <div class="col">
      <input type="number" id="taxRate" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© % (Ù…Ø«Ù„ 15)" value="15" step="0.1" min="0">
    </div>
    <div class="col">
      <input type="url" id="logoUrl" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± (Ø«Ø§Ø¨Øª)" value="">
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ (Ù†Øµ) + ÙˆØµÙ + Ù…Ø¨Ù„Øº -->
  <div style="margin: 25px 0 10px; font-weight:700;">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø£Ø¶Ù Ø¨ÙƒÙŠÙÙƒ):</div>
  <table id="itemsTable">
    <thead><tr><th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬</th><th>ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø³)</th><th></th></tr></thead>
    <tbody id="itemsBody">
      <tr class="item-row">
        <td><input type="text" class="itemType" value="Ø·ÙŠØ±Ø§Ù†" placeholder="Ù…Ø«Ø§Ù„: Ø·ÙŠØ±Ø§Ù†"></td>
        <td><input type="text" class="itemDesc" value="ØªØ°Ø§ÙƒØ± Ø·ÙŠØ±Ø§Ù†"></td>
        <td><input type="number" class="itemAmount" value="800"></td>
        <td><button class="btn-light" onclick="removeItemRow(this)">âœ–</button></td>
      </tr>
      <tr class="item-row">
        <td><input type="text" class="itemType" value="ÙÙ†Ø§Ø¯Ù‚"></td>
        <td><input type="text" class="itemDesc" value="Ø­Ø¬Ø² ÙÙ†Ø¯Ù‚"></td>
        <td><input type="number" class="itemAmount" value="2500"></td>
        <td><button class="btn-light" onclick="removeItemRow(this)">âœ–</button></td>
      </tr>
      <tr class="item-row">
        <td><input type="text" class="itemType" value="Ø³ÙŠØ§Ø±Ø§Øª"></td>
        <td><input type="text" class="itemDesc" value="Ø§Ø³ØªØ¦Ø¬Ø§Ø± Ø³ÙŠØ§Ø±Ø§Øª"></td>
        <td><input type="number" class="itemAmount" value="1200"></td>
        <td><button class="btn-light" onclick="removeItemRow(this)">âœ–</button></td>
      </tr>
    </tbody>
  </table>

  <div class="row">
    <div class="col"><button onclick="addItemRow()" class="btn-light">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button></div>
    <div class="col">
      <select id="paymentMethod">
        <option value="ÙƒØ§Ø´">ğŸ’° ÙƒØ§Ø´</option>
        <option value="ØªØ§Ø¨ÙŠ">ğŸ’³ ØªØ§Ø¨ÙŠ</option>
        <option value="ØªÙ…Ø§Ø±Ø§">ğŸ’³ ØªÙ…Ø§Ø±Ø§</option>
        <option value="Ù…Ø¯Ù‰">ğŸ’³ Ù…Ø¯Ù‰</option>
        <option value="ÙƒÙˆØ§Ø±Ø§">ğŸ’³ ÙƒÙˆØ§Ø±Ø§</option>
      </select>
    </div>
    <div class="col"><input type="number" id="paidAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø§Ù„Ù…Ø­Ø¯Ø¯)" value="500"></div>
    <div class="col"><button onclick="generatePDF()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF</button></div>
    <div class="col"><button onclick="saveInvoice()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button></div>
    <div class="col"><button class="whatsapp-btn" onclick="sendPDFviaWhatsApp()"><span>ğŸ“±</span> ÙˆØ§ØªØ³Ø§Ø¨ PDF</button></div>
  </div>

  <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
  <div class="invoice" id="invoicePreview">
    <div class="invoice-header">
      <div class="shop-details">
        <h1>Ù„ÙŠØ± Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª <span style="font-size:18px; color:#56748c;">(LEER)</span></h1>
        <p>ğŸ“ 00966114819055</p>
        <p>ğŸ“ Ø­ÙØ± Ø§Ù„Ø¨Ø§Ø·Ù† - Ø´Ø§Ø±Ø¹ Ø§Ù„ÙˆÙ„ÙŠØ¯ Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù…Ù„Ùƒ</p>
        <p class="tax-badge" id="shopTaxDisplay">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ: 30053087540003</p>
        <p id="customTaxDisplay"></p>
      </div>
      <div class="logo-area">
        <img id="logoPreview" class="logo" src="" alt="Ø§Ù„Ø´Ø¹Ø§Ø±" crossorigin="anonymous">
      </div>
    </div>

    <div class="invoice-meta">
      <span>ğŸ§¾ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: <strong id="invoiceSerial">0529139</strong></span>
      <span>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: <strong id="invoiceDate">2022-05-29</strong></span>
    </div>

    <div class="customer-info">
      <div class="row">
        <div class="col"><span>Ø§Ù„Ø¹Ù…ÙŠÙ„: <strong id="previewClient">Ù…Ø­Ù…Ø¯ Ø³Ù„ÙŠÙ…Ø§Ù†</strong></span></div>
        <div class="col"><span>Ø§Ù„Ø¬ÙˆØ§Ù„: <strong id="previewPhone">Ù Ù¡Ù Ù¡Ù¢Ù£Ù©Ù Ù£Ù£Ù©</strong></span></div>
        <div class="col"><span>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ: <strong id="previewTaxId">123123123123</strong></span></div>
        <div class="col"><span>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: <strong id="previewIssuer">(1) - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</strong></span></div>
      </div>
    </div>

    <div class="payment-method">
      <span style="font-weight:600;">ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</span> 
      <span id="previewPayment" style="background:white; padding:5px 20px; border-radius:40px;">ÙƒØ§Ø´</span>
    </div>

    <table>
      <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
      <tbody id="previewItemsBody"></tbody>
    </table>

    <div class="totals">
      <div class="total-line"><span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯:</span> <span id="previewSubtotal">4500.00</span> Ø±.Ø³</div>
      <div class="total-line" id="taxLine"><span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (<span id="taxRateDisplay">15</span>%):</span> <span id="previewTaxAmount">675.00</span> Ø±.Ø³</div>
      <div class="total-line grand-total"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span> <span id="previewTotal">5175.00</span> Ø±.Ø³</div>
      <div class="total-line"><span>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span> <span id="previewPaid">500.00</span> Ø±.Ø³</div>
      <div class="total-line" style="color:#b93b2b;"><span>â³ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span> <span id="previewRemaining">4675.00</span> Ø±.Ø³</div>
    </div>

    <div class="thanks-message">Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ³ÙˆÙ‚Ùƒ Ù…Ù† Ù„ÙŠØ± Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª</div>
    <div class="qr-section" id="qrcode"></div>
  </div>

  <div class="saved-list" id="savedList"></div>
</div>

<script>
  (function() {
    const { jsPDF } = window.jspdf;

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    const clientName = document.getElementById('clientName');
    const clientPhone = document.getElementById('clientPhone');
    const clientTaxId = document.getElementById('clientTaxId');
    const issuer = document.getElementById('issuer');
    const taxRateInput = document.getElementById('taxRate');
    const paymentMethod = document.getElementById('paymentMethod');
    const paidAmount = document.getElementById('paidAmount');
    const logoUrl = document.getElementById('logoUrl');
    const logoPreview = document.getElementById('logoPreview');

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    const previewClient = document.getElementById('previewClient');
    const previewPhone = document.getElementById('previewPhone');
    const previewTaxId = document.getElementById('previewTaxId');
    const previewIssuer = document.getElementById('previewIssuer');
    const previewPayment = document.getElementById('previewPayment');
    const invoiceSerial = document.getElementById('invoiceSerial');
    const invoiceDate = document.getElementById('invoiceDate');
    const previewSubtotal = document.getElementById('previewSubtotal');
    const previewTaxAmount = document.getElementById('previewTaxAmount');
    const previewTotal = document.getElementById('previewTotal');
    const previewPaid = document.getElementById('previewPaid');
    const previewRemaining = document.getElementById('previewRemaining');
    const taxRateDisplay = document.getElementById('taxRateDisplay');
    const previewItemsBody = document.getElementById('previewItemsBody');
    const qrcodeDiv = document.getElementById('qrcode');

    // Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    function formatSAR(num) {
      return Number(num).toFixed(2).replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[parseInt(d)]);
    }

    // ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø©
    function generateSerial() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø®Ø²Ù†
    function loadLogoFromUrl() {
      let url = logoUrl.value.trim();
      if (url) {
        logoPreview.src = url;
        localStorage.setItem('logoUrl', url);
      } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø§Ø¨Ø· Ù…Ø®Ø²Ù† Ù…Ø³Ø¨Ù‚Ø§Ù‹
        let savedUrl = localStorage.getItem('logoUrl');
        if (savedUrl) {
          logoUrl.value = savedUrl;
          logoPreview.src = savedUrl;
        }
      }
    }

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = function() {
      invoiceSerial.textContent = generateSerial();
      const today = new Date();
      invoiceDate.textContent = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      
      // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø±
      let savedUrl = localStorage.getItem('logoUrl');
      if (savedUrl) {
        logoUrl.value = savedUrl;
        logoPreview.src = savedUrl;
      }

      loadInvoices();
      renderPreview();
    };

    // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø±
    logoUrl.addEventListener('input', function() {
      let url = logoUrl.value.trim();
      if (url) {
        logoPreview.src = url;
        localStorage.setItem('logoUrl', url);
      }
    });

    // Ø¥Ø¶Ø§ÙØ© ØµÙ Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
    window.addItemRow = function() {
      const tbody = document.getElementById('itemsBody');
      const newRow = document.createElement('tr');
      newRow.className = 'item-row';
      newRow.innerHTML = `
        <td><input type="text" class="itemType" value="Ù…Ù†ØªØ¬" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬"></td>
        <td><input type="text" class="itemDesc" value="ÙˆØµÙ" placeholder="Ø§Ù„ÙˆØµÙ"></td>
        <td><input type="number" class="itemAmount" value="0"></td>
        <td><button class="btn-light" onclick="removeItemRow(this)">âœ–</button></td>
      `;
      tbody.appendChild(newRow);
      attachListeners();
      renderPreview();
    };

    window.removeItemRow = function(btn) {
      if (document.querySelectorAll('.item-row').length <= 1) {
        alert("ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ù„Ù‰ Ø¨Ù†Ø¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
        return;
      }
      btn.closest('tr').remove();
      renderPreview();
    };

    // Ø±Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª
    function attachListeners() {
      document.querySelectorAll('.itemType, .itemDesc, .itemAmount').forEach(el => {
        el.removeEventListener('input', renderPreview);
        el.addEventListener('input', renderPreview);
      });
    }
    attachListeners();

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    function renderPreview() {
      previewClient.textContent = clientName.value || 'â€”';
      let phoneArabic = clientPhone.value.replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[parseInt(d)]);
      previewPhone.textContent = phoneArabic || 'â€”';
      previewTaxId.textContent = clientTaxId.value || 'â€”';
      previewIssuer.textContent = issuer.value || 'â€”';
      previewPayment.textContent = paymentMethod.value;

      const taxRate = parseFloat(taxRateInput.value) || 0;
      taxRateDisplay.textContent = taxRate;

      // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      const typeInputs = document.querySelectorAll('.itemType');
      const descInputs = document.querySelectorAll('.itemDesc');
      const amountInputs = document.querySelectorAll('.itemAmount');

      let items = [];
      let subtotal = 0;
      for (let i = 0; i < descInputs.length; i++) {
        let type = typeInputs[i]?.value || '';
        let desc = descInputs[i].value || 'Ø¨Ù†Ø¯';
        let amt = parseFloat(amountInputs[i].value) || 0;
        items.push({ type, desc, amt });
        subtotal += amt;
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
      let previewRows = '';
      items.forEach(item => {
        previewRows += `<tr><td>${item.desc} (${item.type})</td><td>${formatSAR(item.amt)} Ø±.Ø³</td></tr>`;
      });
      previewItemsBody.innerHTML = previewRows;

      const taxAmount = subtotal * (taxRate / 100);
      const total = subtotal + taxAmount;
      const paid = parseFloat(paidAmount.value) || 0;
      const remaining = total - paid;

      previewSubtotal.textContent = formatSAR(subtotal);
      previewTaxAmount.textContent = formatSAR(taxAmount);
      previewTotal.textContent = formatSAR(total);
      previewPaid.textContent = formatSAR(paid);
      previewRemaining.textContent = formatSAR(remaining);

      // QR Code
      qrcodeDiv.innerHTML = '';
      let qrText = `Ù„ÙŠØ± Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª\nØ±Ù‚Ù…: ${invoiceSerial.textContent}\nØ§Ù„Ø¹Ù…ÙŠÙ„: ${clientName.value}\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(2)} SAR\nØ§Ù„Ø¯ÙØ¹: ${paymentMethod.value}`;
      new QRCode(qrcodeDiv, { text: qrText, width: 100, height: 100 });
    }

    // Ø¥Ù†Ø´Ø§Ø¡ PDF ÙˆØªØ­Ù…ÙŠÙ„Ù‡
    window.generatePDF = async function() {
      const original = document.getElementById("invoicePreview");
      const clone = original.cloneNode(true);
      clone.style.position = "absolute";
      clone.style.left = "-9999px";
      clone.style.width = "794px";
      clone.style.background = "white";
      document.body.appendChild(clone);

      const canvas = await html2canvas(clone, { scale: 2.5, backgroundColor: '#ffffff', useCORS: true });
      document.body.removeChild(clone);

      const imgData = canvas.toDataURL("image/png");
      const pdf = new jsPDF("p", "mm", "a4");
      const pdfWidth = 210;
      const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
      pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
      pdf.save(`ÙØ§ØªÙˆØ±Ø©_${invoiceSerial.textContent}.pdf`);
      return pdf; // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ø±Ø¬Ø§Ø¹Ù‡
    };

    // Ø¥Ø±Ø³Ø§Ù„ PDF Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ (ØªØ­Ù…ÙŠÙ„ Ø«Ù… ÙØªØ­ Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø±Ø³Ø§Ù„Ø©)
    window.sendPDFviaWhatsApp = async function() {
      let phone = clientPhone.value.replace(/\D/g, '');
      if (!phone) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }

      // Ø¥Ù†Ø´Ø§Ø¡ PDF ÙˆØªØ­Ù…ÙŠÙ„Ù‡
      await generatePDF(); // Ù‡Ø°Ø§ Ø³ÙŠØ­Ù…Ù‘Ù„ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹

      // Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶Ø­ ÙƒÙŠÙÙŠØ© Ø¥Ø±Ø³Ø§Ù„ PDF Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
      const message = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ ÙØ§ØªÙˆØ±ØªÙƒ Ù…Ù† Ù„ÙŠØ± Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª Ù…Ø±ÙÙ‚Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (PDF). Ø¨Ø±Ø¬Ø§Ø¡ ÙØªØ­ Ø§Ù„Ù…Ø±ÙÙ‚. Ø´ÙƒØ±Ø§Ù‹.`;
      const encoded = encodeURIComponent(message);
      window.open(`https://wa.me/${phone}?text=${encoded}`, '_blank');

      // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±ÙØ§Ù‚ PDF ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ ÙˆÙ„ÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù…Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹.
      setTimeout(() => {
        alert("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù PDF. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø±ÙØ§Ù‚Ù‡ Ù…Ø¹ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù Ù…Ù† Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª).");
      }, 1000);
    };

    // Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    window.saveInvoice = function() {
      const typeInputs = document.querySelectorAll('.itemType');
      const descInputs = document.querySelectorAll('.itemDesc');
      const amountInputs = document.querySelectorAll('.itemAmount');
      let items = [];
      for (let i = 0; i < descInputs.length; i++) {
        items.push({
          type: typeInputs[i]?.value || '',
          desc: descInputs[i].value,
          amt: parseFloat(amountInputs[i].value) || 0
        });
      }

      const invoiceData = {
        serial: invoiceSerial.textContent,
        date: invoiceDate.textContent,
        client: clientName.value,
        phone: clientPhone.value,
        clientTaxId: clientTaxId.value,
        issuer: issuer.value,
        taxRate: taxRateInput.value,
        payment: paymentMethod.value,
        paid: parseFloat(paidAmount.value) || 0,
        items: items,
        logoUrl: logoUrl.value
      };

      let list = JSON.parse(localStorage.getItem('invoices') || '[]');
      list.push(invoiceData);
      localStorage.setItem('invoices', JSON.stringify(list));
      loadInvoices();
    };

    function loadInvoices() {
      let list = JSON.parse(localStorage.getItem('invoices') || '[]');
      let savedDiv = document.getElementById('savedList');
      savedDiv.innerHTML = '<h3>ğŸ“‚ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h3>';
      list.forEach((inv, idx) => {
        let div = document.createElement('div');
        div.className = 'saved-item';
        div.textContent = `${inv.serial} - ${inv.client || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'} - ${inv.date}`;
        div.onclick = () => {
          clientName.value = inv.client || '';
          clientPhone.value = inv.phone || '';
          clientTaxId.value = inv.clientTaxId || '';
          issuer.value = inv.issuer || '';
          taxRateInput.value = inv.taxRate || '15';
          paymentMethod.value = inv.payment || 'ÙƒØ§Ø´';
          paidAmount.value = inv.paid || 0;
          invoiceSerial.textContent = inv.serial;
          invoiceDate.textContent = inv.date;
          logoUrl.value = inv.logoUrl || '';
          if (logoUrl.value) logoPreview.src = logoUrl.value;

          // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
          const tbody = document.getElementById('itemsBody');
          tbody.innerHTML = '';
          if (inv.items && inv.items.length) {
            inv.items.forEach(it => {
              let row = document.createElement('tr');
              row.className = 'item-row';
              row.innerHTML = `
                <td><input type="text" class="itemType" value="${it.type.replace(/"/g, '&quot;')}"></td>
                <td><input type="text" class="itemDesc" value="${it.desc.replace(/"/g, '&quot;')}"></td>
                <td><input type="number" class="itemAmount" value="${it.amt}"></td>
                <td><button class="btn-light" onclick="removeItemRow(this)">âœ–</button></td>
              `;
              tbody.appendChild(row);
            });
          } else {
            addItemRow();
          }
          attachListeners();
          renderPreview();
        };
        savedDiv.appendChild(div);
      });
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ù„Ù„ØªØºÙŠÙŠØ±
    [clientName, clientPhone, clientTaxId, issuer, taxRateInput, paymentMethod, paidAmount].forEach(el => {
      el.addEventListener('input', renderPreview);
    });
    document.addEventListener('input', renderPreview);
    renderPreview();
  })();
</script>

<!-- Ø¯Ø§Ù„Ø© removeItemRow Ù„Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« -->
<script>
  window.removeItemRow = function(btn) {
    if (document.querySelectorAll('.item-row').length <= 1) {
      alert("ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¹Ù„Ù‰ Ø¨Ù†Ø¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
      return;
    }
    btn.closest('tr').remove();
    if (window.renderPreview) window.renderPreview();
  };
</script>
</body>
</html>