    <script>
        // دالة تهيئة الشريط العلوي
        function updateNavbarBasedOnLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const userType = localStorage.getItem('userType');
            const desktopNavLinks = document.querySelector('.desktop-nav-links');
            const desktopAuthLinks = desktopNavLinks ? desktopNavLinks.querySelectorAll('.auth-link') : [];
            const desktopGuestButton = document.getElementById('nav-guest-button');
            const desktopUserProfilePlaceholder = document.getElementById('nav-user-profile-placeholder');

            if (desktopGuestButton) desktopGuestButton.style.display = 'none';
            if (desktopUserProfilePlaceholder) desktopUserProfilePlaceholder.style.display = 'none';
            desktopAuthLinks.forEach(link => link.style.display = 'none');

            if (isLoggedIn) {
                if (desktopUserProfilePlaceholder) {
                    desktopUserProfilePlaceholder.innerHTML = `
                        <a href="#" class="btn btn-outline" onclick="logoutUser()" style="margin-right: 10px;">
                            <i class="fas fa-sign-out-alt"></i> خروج
                        </a>
                        <a href="${userType === 'owner' ? 'dashboard-owner.html' : 'dashboard-renter.html'}" class="btn btn-secondary">
                            <i class="fas fa-user-circle"></i> ملفي
                        </a>
                    `;
                    desktopUserProfilePlaceholder.style.display = 'flex';
                }
                desktopAuthLinks.forEach(link => {
                    const linkHref = link.getAttribute('href');
                    if (userType === 'owner' && linkHref && (linkHref.includes('dashboard-owner.html') || linkHref.includes('add-car.html'))) {
                        link.style.display = 'block';
                    } else if (userType === 'renter' && linkHref && linkHref.includes('dashboard-renter.html')) {
                        link.style.display = 'block';
                    }
                });
            } else {
                if (desktopGuestButton) desktopGuestButton.style.display = 'flex';
            }
        }

        function logoutUser() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userType');
            window.location.href = 'index.html';
        }

        // --- منطق الخريطة والبيانات ---
        let map;
        let carMarkersLayer;

        // الإحداثيات اللي طلبتها بالضبط (واجهة روشن)
        const targetLocation = [24.8375090, 46.7297325];

        const cities = {
            riyadh: targetLocation, // المركز هو نفس النقطة
            dammam: [26.4350, 50.1150],
            khobar: [26.2900, 50.2100],
            jeddah: [21.5500, 39.1600]
        };

        // قاعدة بيانات السيارات (كل سيارات الرياض حول النقطة المحددة)
        // ملاحظة: غيرت الارقام الاخيرة في الاحداثيات تغيير بسيط عشان ما يركبون فوق بعض
        const allCars = [
            // --- الرياض (واجهة روشن - التجمع الرئيسي) ---
            { city: 'riyadh', id: 'r1', type: 'سيدان', model: 'تويوتا كامري 2024', price: '120', rating: 4.9, reviews: 52, loc: 'واجهة روشن - نقطة التجمع', lat: 24.8375090, lng: 46.7297325, img: 'https://tse2.mm.bing.net/th/id/OIP.F3b-M0eckL0XjmywTpu8EgHaFj?rs=1&pid=ImgDetMain&o=7&rm=3' },
            { city: 'riyadh', id: 'r2', type: 'دفع رباعي', model: 'تويوتا لاندكروزر', price: '450', rating: 5.0, reviews: 18, loc: 'واجهة روشن - المواقف', lat: 24.8376000, lng: 46.7298000, img: 'https://www.autopediame.com/userfiles/images/%D9%84%D8%A7%D9%86%D8%AF%D9%83%D8%B1%D9%88%D8%B2%D8%B1/%D8%AA%D9%88%D9%8A%D9%88%D8%AA%D8%A7%20%D9%84%D8%A7%D9%86%D8%AF%D9%83%D8%B1%D9%88%D8%B2%D8%B1%201.jpg' },
            { city: 'riyadh', id: 'r3', type: 'فاخرة', model: 'مرسيدس S500', price: '900', rating: 4.8, reviews: 12, loc: 'واجهة روشن - VIP', lat: 24.8374000, lng: 46.7296000, img: 'https://media.elbalad.news/2024/10/large/995/9/554.jpg' },
            { city: 'riyadh', id: 'r4', type: 'سيدان', model: 'هونداي النترا', price: '85', rating: 4.7, reviews: 89, loc: 'واجهة روشن - بوابة 2', lat: 24.8377000, lng: 46.7299000, img: 'https://static.sayidaty.net/styles/900_scale/public/2022-03/80578.jpeg.webp' },
            
            // تكرار إضافي قريب جداً
            { city: 'riyadh', id: 'r5', type: 'سيدان', model: 'تويوتا كامري 2023', price: '115', rating: 4.6, reviews: 40, loc: 'واجهة روشن', lat: 24.8373000, lng: 46.7295000, img: 'https://tse2.mm.bing.net/th/id/OIP.F3b-M0eckL0XjmywTpu8EgHaFj?rs=1&pid=ImgDetMain&o=7&rm=3' },
            { city: 'riyadh', id: 'r6', type: 'سيدان', model: 'هونداي النترا', price: '80', rating: 4.5, reviews: 33, loc: 'واجهة روشن', lat: 24.8378000, lng: 46.7300000, img: 'https://static.sayidaty.net/styles/900_scale/public/2022-03/80578.jpeg.webp' },
            { city: 'riyadh', id: 'r7', type: 'دفع رباعي', model: 'شيفروليه تاهو', price: '380', rating: 4.9, reviews: 22, loc: 'واجهة روشن', lat: 24.8372000, lng: 46.7294000, img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR_xL-R8y8f_Q_g_h_j_k_l_m_n_o_p' },

            // --- باقي المدن ---
            { city: 'dammam', id: 'd1', type: 'سيدان', model: 'تويوتا كامري 2023', price: '110', rating: 4.8, reviews: 30, loc: 'الشاطئ مول', lat: 26.4400, lng: 50.1100, img: 'https://tse2.mm.bing.net/th/id/OIP.F3b-M0eckL0XjmywTpu8EgHaFj?rs=1&pid=ImgDetMain&o=7&rm=3' },
            { city: 'khobar', id: 'k1', type: 'فاخرة', model: 'مرسيدس S-Class', price: '950', rating: 5.0, reviews: 8, loc: 'فندق المريديان', lat: 26.2920, lng: 50.2120, img: 'https://media.elbalad.news/2024/10/large/995/9/554.jpg' },
            { city: 'jeddah', id: 'j1', type: 'سيدان', model: 'تويوتا كامري', price: '115', rating: 4.8, reviews: 60, loc: 'الرد سي مول', lat: 21.6200, lng: 39.1100, img: 'https://tse2.mm.bing.net/th/id/OIP.F3b-M0eckL0XjmywTpu8EgHaFj?rs=1&pid=ImgDetMain&o=7&rm=3' }
        ];

        function initMap() {
            if (document.getElementById('mapid') && typeof L !== 'undefined') {
                // إجبار الخريطة تبدأ على إحداثيات واجهة روشن
                map = L.map('mapid').setView(targetLocation, 17); // زوم 17 عشان يبينون قريبين

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap'
                }).addTo(map);

                carMarkersLayer = L.layerGroup().addTo(map);
                renderCars();
                
                // تحديث إضافي للتأكيد
                setTimeout(() => {
                    map.invalidateSize();
                    map.panTo(targetLocation);
                }, 500);
            }
        }

        // إنشاء أيقونة السيارة (مخصص)
        function createCarIcon(carType) {
            let color = 'var(--primary)';
            if(carType === 'فاخرة') color = '#f1c40f';
            if(carType === 'دفع رباعي') color = '#e67e22';

            return L.divIcon({
                className: 'custom-car-icon',
                html: `<i class="fas fa-car" style="color:${color}; line-height:36px; font-size:1.2rem;"></i>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });
        }

        // ستايل الأيقونات الديناميكي
        const style = document.createElement('style');
        style.innerHTML = `
            .custom-car-icon {
                background-color: white;
                border-radius: 50%;
                text-align: center;
                border: 2px solid var(--primary);
                box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                transition: transform 0.2s;
            }
            .custom-car-icon:hover {
                transform: scale(1.15);
                z-index: 1000 !important;
            }
            body.dark-mode .custom-car-icon { background-color: #333; border-color: #fff; }
        `;
        document.head.appendChild(style);

        // متغيرات الفلترة
        let currentCity = 'riyadh';
        let currentType = 'الكل';

        function changeCity() {
            currentCity = document.getElementById('city-selector').value;
            // عند تغيير المدينة
            const zoomLevel = (currentCity === 'riyadh') ? 17 : 13;
            map.flyTo(cities[currentCity], zoomLevel, { duration: 1.5 });
            renderCars();
        }

        function filterMap(type, element) {
            currentType = type;
            document.querySelectorAll('.filter-tag').forEach(btn => btn.classList.remove('active'));
            if(element) element.classList.add('active');
            renderCars();
        }

        function renderCars() {
            carMarkersLayer.clearLayers();
            
            const filtered = allCars.filter(car => {
                const cityMatch = car.city === currentCity;
                const typeMatch = currentType === 'الكل' ? true : car.type === currentType;
                return cityMatch && typeMatch;
            });

            filtered.forEach(car => {
                const marker = L.marker([car.lat, car.lng], { icon: createCarIcon(car.type) }).addTo(carMarkersLayer);
                
                const popupContent = `
                    <div class="popup-car-details" style="text-align:right;">
                        <img src="${car.img}" style="width:100%; height:120px; object-fit:cover; border-radius:8px; margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h4 style="color:var(--primary); margin:0;">${car.model}</h4>
                            <div class="rating-badge"><i class="fas fa-star"></i> ${car.rating}</div>
                        </div>
                        <div style="font-size:0.9rem; color:#666; margin:5px 0;">
                            <i class="fas fa-map-marker-alt" style="color:var(--secondary);"></i> ${car.loc}
                        </div>
                        <div style="font-weight:bold; color:var(--secondary); margin-bottom:10px;">
                            ${car.price} ريال/يوم
                        </div>
                        <a href="cars.html?carId=${car.id}" class="btn btn-primary" style="display:block; text-align:center; padding:8px; font-size:0.9rem;">
                            حجز فوري
                        </a>
                    </div>
                `;
                marker.bindPopup(popupContent);
                car.marker = marker;
            });
        }

        // --- محاكاة العثور على الأقرب (Smart Locate) ---
        function simulateSmartLocate() {
            const btn = document.getElementById('smart-locate-btn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-satellite-dish fa-spin"></i> جاري تحديد موقعك...';
            btn.style.opacity = '0.8';

            setTimeout(() => {
                // محاكاة: العثور على سيارة في نفس المدينة الحالية
                const visibleCars = allCars.filter(c => c.city === currentCity);
                
                if (visibleCars.length > 0) {
                    const nearest = visibleCars[0]; 
                    btn.innerHTML = '<i class="fas fa-check"></i> تم العثور على مركبة!';
                    btn.style.background = '#2ecc71';
                    
                    map.flyTo([nearest.lat, nearest.lng], 17, { duration: 1 });
                    setTimeout(() => {
                        if(nearest.marker) nearest.marker.openPopup();
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.style.background = '';
                            btn.style.opacity = '1';
                        }, 3000);
                    }, 1200);
                } else {
                    btn.innerHTML = '<i class="fas fa-times"></i> لا توجد سيارات قريبة';
                    btn.style.background = '#e74c3c';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                        btn.style.opacity = '1';
                    }, 2000);
                }
            }, 1500);
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateNavbarBasedOnLoginStatus();
            setTimeout(initMap, 500);
        });
    </script>
